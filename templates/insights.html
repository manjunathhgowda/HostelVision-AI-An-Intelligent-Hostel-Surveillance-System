
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Insights - HostelVision</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        body { background-color: #f4f6f9; }
        .card { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .select-box { max-width: 300px; }
        .table-container { max-height: 300px; overflow-y: auto; }
        #attendanceChart, #calendarChart { max-height: 300px; }
        body, h1, h2, h3, p,td, select, option {
        color: white !important;
        }
        .card {
            background: #1f2937; /* dark gray */
        }
        table thead {
            background-color: #374151; /* darker for contrast */
        }
        .select-box {
            background-color: #1f2937;
            color: white;
        }
    </style>
</head>
<body class="min-h-screen">
    {% extends "base.html" %}
    {% block content %}
    <div class="container mx-auto p-4">
        <h1 class="text-2xl font-bold mb-6 text-center text-gray-800">Attendance Insights</h1>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- User Selection and History -->
            <div class="card p-4">
                <h2 class="text-lg font-semibold mb-4 text-gray-700">User Attendance History</h2>
                <select id="userSelect" class="select-box border rounded p-2 mb-4 w-full">
                    <option value="">Select Hostelite</option>
                    {% for hostelite in hostelites %}
                    <option value="{{ hostelite.user_id }}">{{ hostelite.name }}</option>
                    {% endfor %}
                </select>
                <div class="table-container">
                    <table class="w-full text-sm text-gray-600">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="p-2 text-left">Date</th>
                                <th class="p-2 text-left">Time</th>
                                <th class="p-2 text-left">Status</th>
                                <th class="p-2 text-left">Confidence</th>
                            </tr>
                        </thead>
                        <tbody id="userHistoryTable"></tbody>
                    </table>
                </div>
                <div class="mt-4">
                    <h3 class="text-md font-semibold mb-2 text-gray-700">Attendance Trend</h3>
                    <canvas id="attendanceChart"></canvas>
                </div>
                <div class="mt-4">
                    <h3 class="text-md font-semibold mb-2 text-gray-700">Zone Breaches</h3>
                    <p id="zoneBreachInfo" class="text-sm text-gray-600"></p>
                    <div class="table-container">
                        <table class="w-full text-sm text-gray-600">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="p-2 text-left">Date</th>
                                    <th class="p-2 text-left">Time</th>
                                    <th class="p-2 text-left">Photo</th>
                                </tr>
                            </thead>
                            <tbody id="zoneBreachTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- Date Selection and Report -->
            <div class="card p-4">
                <h2 class="text-lg font-semibold mb-4 text-gray-700">Date-Based Report</h2>
                <select id="dateSelect" class="select-box border rounded p-2 mb-4 w-full">
                    <option value="">Select Date</option>
                    {% for date in dates %}
                    <option value="{{ date }}">{{ date }}</option>
                    {% endfor %}
                </select>
                <div class="table-container">
                    <table class="w-full text-sm text-gray-600">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="p-2 text-left">User ID</th>
                                <th class="p-2 text-left">Name</th>
                                <th class="p-2 text-left">Status</th>
                                <th class="p-2 text-left">Time</th>
                            </tr>
                        </thead>
                        <tbody id="dateReportTable"></tbody>
                    </table>
                </div>
                <div class="mt-4">
                    <h3 class="text-md font-semibold mb-2 text-gray-700">Attendance Breakdown</h3>
                    <div style="max-width: 300px; margin: auto;">
                        <canvas id="statusChart"></canvas>
                    </div>

                </div>
                <div class="mt-4">
                    <h3 class="text-md font-semibold mb-2 text-gray-700">Intrusion Stats</h3>
                    <p id="visitorInfo" class="text-sm text-gray-600"></p>
                    <p id="breachInfo" class="text-sm text-gray-600"></p>
                </div>
            </div>
        </div>
    </div>
    <script>
        let attendanceChart, statusChart, monthlyChart, calendarChart;

        // User Selection
        document.getElementById('userSelect').addEventListener('change', async (e) => {
            const userId = e.target.value;
            if (!userId) {
                document.getElementById('userHistoryTable').innerHTML = '';
                document.getElementById('zoneBreachInfo').innerHTML = '';
                document.getElementById('zoneBreachTable').innerHTML = '';
                if (attendanceChart) attendanceChart.destroy();
                return;
            }
            const response = await fetch(`/individual_history/${userId}`);
            const history = await response.json();
            // Update History Table
            document.getElementById('userHistoryTable').innerHTML = history.map(row => `
                <tr>
                    <td class="p-2">${row.date}</td>
                    <td class="p-2">${row.time}</td>
                    <td class="p-2">${row.status}</td>
                    <td class="p-2">${row.confidence ? row.confidence.toFixed(2) + '%' : '-'}</td>
                </tr>
            `).join('');
            // Update Zone Breach Info
            const breachCount = {{ zone_breaches | tojson }}[userId] || 0;
            document.getElementById('zoneBreachInfo').innerHTML = breachCount ? `Zone Breaches: ${breachCount}` : 'No zone breaches recorded.';
            // Fetch Zone Breaches
            const breaches = {{ geo_fence_breaches | tojson }}.filter(b => b.user_id === userId);
            document.getElementById('zoneBreachTable').innerHTML = breaches.map(b => `
                <tr>
                    <td class="p-2">${b.date}</td>
                    <td class="p-2">${b.time}</td>
                    <td class="p-2"><img src="${b.image_url}" alt="Breach" class="w-12 h-12 object-cover"></td>
                </tr>
            `).join('');
            // Update Attendance Chart
            if (attendanceChart) attendanceChart.destroy();
            attendanceChart = new Chart(document.getElementById('attendanceChart'), {
                type: 'line',
                data: {
                    labels: history.map(h => h.date),
                    datasets: [{
                        label: 'Attendance Status',
                        data: history.map(h => h.status === 'Present' ? 1 : 0),
                        borderColor: '#4CAF50',
                        fill: false,
                        pointRadius: 6,
                        pointHoverRadius: 7,
                        pointBackgroundColor: history.map(h => h.status === 'Present' ? '#4CAF50' : '#EF4444'),  // Green for present, red for absent
                        tension: 0.3,
                        pointBorderColor: history.map(h => h.status === 'Present' ? '#4CAF50' : '#EF4444'),
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { min: 0, max: 1.5, ticks: { stepSize: 1, callback: v => v === 1 ? 'Present' : v === 0 ? 'Absent' : ''} },
                        x: { type: 'time', time: { unit: 'day' } }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                        label: function(context) {
                            return context.raw === 1 ? 'Present' : 'Absent';
                        }
                        }
                    }
                }

            });
        });

        // Date Selection
        document.getElementById('dateSelect').addEventListener('change', async (e) => {
            const date = e.target.value;
            if (!date) {
                document.getElementById('dateReportTable').innerHTML = '';
                document.getElementById('visitorInfo').innerHTML = '';
                document.getElementById('breachInfo').innerHTML = '';
                if (statusChart) statusChart.destroy();
                return;
            }
            const response = await fetch(`/date_report/${date}`);
            const { present_list, absent_list } = await response.json();
            // Update Date Report Table
            document.getElementById('dateReportTable').innerHTML = [...present_list, ...absent_list].map(row => `
                <tr>
                    <td class="p-2">${row.user_id}</td>
                    <td class="p-2">${row.name}</td>
                    <td class="p-2">${row.status}</td>
                    <td class="p-2">${row.time}</td>
                </tr>
            `).join('');
            // Update Intrusion Stats
            const visitors = {{ notifications | tojson }}.filter(n => n.date === date && n.type === 'Visitor').length;
            const breaches = {{ geo_fence_breaches | tojson }}.filter(b => b.date === date).length;
            document.getElementById('visitorInfo').innerHTML = `Visitors Detected: ${visitors}`;
            document.getElementById('breachInfo').innerHTML = `Zone Breaches: ${breaches}`;
            // Update Status Chart
            if (statusChart) statusChart.destroy();
            statusChart = new Chart(document.getElementById('statusChart'), {
                type: 'pie',
                data: {
                    labels: ['Present', 'Absent'],
                    datasets: [{
                        data: [present_list.length, absent_list.length],
                        backgroundColor: ['#4CAF50', '#EF4444']
                    }]
                },
                options: { plugins: { legend: { position: 'bottom' } } }
            });
        });

        // Monthly Comparison Chart
        monthlyChart = new Chart(document.getElementById('monthlyChart'), {
            type: 'bar',
            data: {
                labels: {{ monthly_comparison | tojson }}.map(m => m.month),
                datasets: [{
                    label: 'Present Count',
                    data: {{ monthly_comparison | tojson }}.map(m => m.present_count),
                    backgroundColor: '#4CAF50'
                }]
            },
            options: {
                scales: { y: { beginAtZero: true } },
                plugins: { legend: { display: false } }
            }
        });

        // Calendar Heatmap
        calendarChart = new Chart(document.getElementById('calendarChart'), {
            type: 'bar',
            data: {
                labels: {{ calendar_data | tojson }}.map(d => d.date),
                datasets: [{
                    label: 'Present Count',
                    data: {{ calendar_data | tojson }}.map(d => d.present_count),
                    backgroundColor: '#4CAF50'
                }]
            },
            options: {
                scales: {
                    x: { type: 'time', time: { unit: 'day' } },
                    y: { beginAtZero: true }
                },
                plugins: { legend: { display: false } }
            }
        });
    </script>
    {% endblock %}
</body>
</html>
